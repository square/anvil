name : CI

on :
  push :
    branches :
      - main
    tags-ignore :
      - '**'
  pull_request :

jobs :
  test-ubuntu :
    runs-on : ubuntu-latest
    timeout-minutes : 25

    strategy :
      fail-fast : false
      matrix :
        kotlin-version : [ 1.8.22, 1.9.0 ]

    steps :
      - uses : actions/checkout@v3
      - uses : actions/setup-java@v3
        with :
          distribution : 'temurin'
          java-version : '11'
          check-latest : true

      - name : Test on Ubuntu
        run : ./gradlew -p compiler assemble test --tests 'com.squareup.anvil.compiler.codegen.ContributesMultibindingGeneratorTest.a contributed multibinding can be generated*' --no-build-cache --no-daemon --stacktrace -Doverride_kotlin=${{ matrix.kotlin-version }}

      - name : Upload Test Results
        uses : actions/upload-artifact@v3
        if : ${{ failure() }}
        with :
          name : test-results-${{ matrix.kotlin-version }}
          path : ./**/build/reports/tests/


  test-windows :
    runs-on : windows-latest
    timeout-minutes : 25

    steps :
      - uses : actions/checkout@v3
      - uses : actions/setup-java@v3
        with :
          distribution : 'temurin'
          java-version : '11'
          check-latest : true

      # On Windows the command looks a little bit different. Notice that we use the .bat file and
      # quotes for the Kotlin version, because dots "." in the Kotlin version and parameter name
      # cause issues.
      #
      # Expressions in Github actions are limited. If there would be an if expression, then we
      # wouldn't need to duplicate the next step and depending on the OS enable / disable them.
      - name : Test on Windows
        run : ./gradlew.bat -p compiler assemble test --tests 'com.squareup.anvil.compiler.codegen.ContributesMultibindingGeneratorTest.a contributed multibinding can be generated*' --no-build-cache --no-daemon --stacktrace -Doverride_config-fullTestRun=false

      - name : Upload Test Results
        uses : actions/upload-artifact@v3
        if : ${{ failure() }}
        with :
          name : test-results-windows
          path : ./**/build/reports/tests/
